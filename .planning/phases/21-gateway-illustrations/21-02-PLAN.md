---
phase: 21-gateway-illustrations
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - site/src/pages/index.astro
  - site/src/styles/global.css
  - site/src/scripts/scroll-reveal.js
autonomous: true

must_haves:
  truths:
    - "Three illustrations appear interspersed in the prose section between paragraph groups"
    - "Illustrations break out wider than the 38rem prose column to approximately 65rem"
    - "Dark mode inverts illustration line art via CSS filter on the img element only"
    - "Each illustration fades in with a slide-up animation when scrolled into view"
    - "Reduced-motion users see illustrations immediately with no animation"
    - "Each illustration has a semantic figure/figcaption with muted caption text"
    - "No horizontal scrollbar appears despite the breakout width"
  artifacts:
    - path: "site/src/pages/index.astro"
      provides: "Three <figure class='illustration'> elements with Astro <Image> components interspersed in prose"
      contains: "illustration"
    - path: "site/src/styles/global.css"
      provides: "Illustration breakout layout, theme-aware filter, scroll reveal states, reduced-motion override"
      contains: "illustration"
    - path: "site/src/scripts/scroll-reveal.js"
      provides: "IntersectionObserver that adds is-visible class to illustrations on scroll"
      contains: "IntersectionObserver"
  key_links:
    - from: "site/src/scripts/scroll-reveal.js"
      to: ".illustration elements"
      via: "querySelectorAll + IntersectionObserver + classList.add('is-visible')"
      pattern: "illustration.*is-visible"
    - from: "site/src/styles/global.css"
      to: "dark mode illustration adaptation"
      via: "[data-theme='dark'] .illustration img { filter: invert(1) }"
      pattern: "data-theme.*dark.*illustration.*invert"
    - from: "site/src/styles/global.css"
      to: "reduced-motion illustration visibility"
      via: "@media (prefers-reduced-motion: reduce) .illustration override"
      pattern: "reduced-motion.*illustration"
    - from: "site/src/pages/index.astro"
      to: "scroll-reveal.js"
      via: "script import"
      pattern: "scroll-reveal"
---

<objective>
Integrate the three illustrations into the landing page with CSS breakout layout, theme-aware dark mode, and scroll-triggered fade-in reveals.

Purpose: The illustrations created in Plan 01 need to be placed between prose paragraphs with a wider breakout layout, adapt to dark/light mode via CSS filter inversion, and fade in on scroll using IntersectionObserver. This plan handles all markup, styling, and JavaScript for the illustration integration.

Output: Updated index.astro with illustration markup, updated global.css with illustration styles, new scroll-reveal.js with IntersectionObserver logic.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-gateway-illustrations/21-CONTEXT.md
@.planning/phases/21-gateway-illustrations/21-RESEARCH.md
@.planning/phases/21-gateway-illustrations/21-01-SUMMARY.md
@site/src/pages/index.astro
@site/src/styles/global.css
@site/src/scripts/scroll-scrubber.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add illustration markup to index.astro and create scroll-reveal.js</name>
  <files>site/src/pages/index.astro, site/src/scripts/scroll-reveal.js</files>
  <action>
**1. index.astro -- Add illustration imports in the frontmatter:**

After the existing `import heroImage from '../assets/hero-primary.png';` line, add:

```astro
import patternImg from '../assets/illustrations/pattern-recognition.png';
import interruptImg from '../assets/illustrations/interrupting-linear.png';
import ancientModernImg from '../assets/illustrations/ancient-modern.png';
```

**2. index.astro -- Insert three illustration figures into the prose section:**

Place illustrations between paragraph groups inside `.prose-inner`. The prose currently has an h2 followed by 8 paragraphs plus the install block. Insert illustrations to create this rhythm:

- h2 heading
- Paragraphs 1-2 (pattern recognition / cards open a different eye)
- **Illustration 1: Pattern Recognition** (after paragraph 2, before paragraph 3)
- Paragraphs 3-4 (Tower card / something cracks open)
- **Illustration 2: Interrupting Linear Thinking** (after paragraph 4, before paragraph 5)
- Paragraphs 5-6 (not mysticism / interrupt itself)
- **Illustration 3: Ancient Meets Modern** (after paragraph 6, before paragraph 7)
- Paragraphs 7-8 + install block

Each illustration uses this exact markup pattern:

```html
<figure class="illustration">
  <Image
    src={patternImg}
    alt="Geometric line drawing of concentric circles with tarot card outlines woven into sacred geometry patterns"
    width={1200}
    format="png"
    loading="lazy"
  />
  <figcaption>Pattern Recognition</figcaption>
</figure>
```

For illustration 2:
```html
<figure class="illustration">
  <Image
    src={interruptImg}
    alt="Line drawing of a straight line fracturing into a Fibonacci spiral with The Tower card emerging from the break"
    width={1200}
    format="png"
    loading="lazy"
  />
  <figcaption>Interrupting Linear Thinking</figcaption>
</figure>
```

For illustration 3:
```html
<figure class="illustration">
  <Image
    src={ancientModernImg}
    alt="Line drawing of a terminal window containing a Flower of Life pattern merging with circuit board traces"
    width={1200}
    format="png"
    loading="lazy"
  />
  <figcaption>Ancient Wisdom, Modern Vessels</figcaption>
</figure>
```

**Important:** Each `<figure>` goes BETWEEN paragraphs -- NOT inside a `<p>` tag. They are siblings of the `<p>` elements within `.prose-inner`.

**3. index.astro -- Add scroll-reveal.js import:**

Add a new `<script>` block after the existing `<script>` that imports `scroll-scrubber.js`:

```astro
<script>
  import '../scripts/scroll-reveal.js';
</script>
```

**4. Create site/src/scripts/scroll-reveal.js:**

```javascript
// Scroll reveal for illustrations using IntersectionObserver
// Fades in illustrations as they enter the viewport
// Respects prefers-reduced-motion (consistent with Phase 20)
(function() {
  // Bail out for reduced-motion users â€” CSS handles visibility
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

  var illustrations = document.querySelectorAll('.illustration');
  if (!illustrations.length) return;

  var observer = new IntersectionObserver(
    function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    },
    {
      threshold: 0.15,
      rootMargin: '0px 0px -50px 0px'
    }
  );

  illustrations.forEach(function(el) {
    observer.observe(el);
  });
})();
```

**Key decisions in this script:**
- `threshold: 0.15` -- triggers when 15% of illustration is visible. Natural for landscape images entering from below.
- `rootMargin: '0px 0px -50px 0px'` -- element must be 50px above viewport bottom to trigger. Prevents animation firing at very tip of visibility.
- `unobserve` after reveal -- one-time animation, no re-triggering on scroll back up.
- Vanilla JS IIFE pattern -- consistent with existing scroll-scrubber.js conventions.
- `var` keyword -- matches existing codebase JS style (no ES6 const/let in IIFEs).
  </action>
  <verify>
- `index.astro` frontmatter contains imports for all three illustration PNGs
- `index.astro` contains three `<figure class="illustration">` elements
- Each figure has an `<Image>` component with `format="png"` and `loading="lazy"`
- Each figure has a `<figcaption>` with descriptive caption text
- Illustrations are placed between paragraph groups (after paragraphs 2, 4, 6)
- `index.astro` contains a script tag importing `scroll-reveal.js`
- `site/src/scripts/scroll-reveal.js` exists with IntersectionObserver logic
- `scroll-reveal.js` contains `prefers-reduced-motion` guard
- `scroll-reveal.js` contains `is-visible` class toggle
- Build succeeds: `cd site && npx astro build`
  </verify>
  <done>Three illustration figures inserted into prose section at thematic breakpoints, scroll-reveal.js created with IntersectionObserver, script imported in index.astro.</done>
</task>

<task type="auto">
  <name>Task 2: Add illustration CSS styles with breakout, theme, and scroll reveal</name>
  <files>site/src/styles/global.css</files>
  <action>
Add illustration styles to `global.css`. Place the new section BETWEEN the existing `/* ===== PROSE SECTION ===== */` styles and the `/* ===== RESPONSIVE ===== */` section.

**1. Add illustration section comment and base styles:**

```css
/* ===== ILLUSTRATIONS ===== */
.illustration {
  /* Breakout from 38rem prose column */
  width: 100vw;
  max-width: 65rem;
  margin-left: 50%;
  padding: 3rem 0;
  text-align: center;

  /* Scroll reveal: hidden state (combines breakout centering + slide up) */
  opacity: 0;
  transform: translateX(-50%) translateY(2rem);
  transition: opacity 0.6s ease, transform 0.6s ease;
}

/* Scroll reveal: visible state */
.illustration.is-visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.illustration img {
  width: 100%;
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto;
}

/* Theme adaptation: invert line art for dark mode (target img only, not caption) */
[data-theme="dark"] .illustration img {
  filter: invert(1);
}

/* Caption styling */
.illustration figcaption {
  font-family: var(--font-body);
  font-size: 0.75rem;
  color: var(--text-prose-muted);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-top: 1rem;
}
```

**2. Add overflow-x: clip to the existing `.prose` rule:**

Find the existing `.prose` rule:
```css
.prose {
  background: var(--bg-page, #FAF9F6);
  padding: 5rem 2rem;
}
```

Add `overflow-x: clip;` to prevent horizontal scrollbar from the breakout layout:
```css
.prose {
  background: var(--bg-page, #FAF9F6);
  padding: 5rem 2rem;
  overflow-x: clip;
}
```

Use `clip` instead of `hidden` -- `clip` prevents the horizontal scrollbar without creating a new scroll context that could interfere with vertical scrolling or IntersectionObserver.

**3. Add illustration responsive style inside the existing `@media (max-width: 640px)` block:**

Add to the existing 640px media query:
```css
.illustration {
  width: calc(100vw - 2rem);
  padding: 2rem 0;
}
```

This constrains the breakout on mobile to leave 1rem margin on each side.

**4. Add illustration reduced-motion override inside the existing `@media (prefers-reduced-motion: reduce)` block:**

Add inside the existing reduced-motion media query at the bottom of global.css:
```css
.illustration {
  opacity: 1 !important;
  transform: translateX(-50%) !important;
  transition: none !important;
}
```

This ensures reduced-motion users see illustrations immediately. The `translateX(-50%)` is preserved because it's the breakout centering transform, not an animation. The `!important` overrides the hidden state from the base `.illustration` rule.

**CRITICAL CSS NOTE:** The breakout centering (`translateX(-50%)`) must ALWAYS be present in the transform. The scroll reveal only adds/removes `translateY(2rem)`. Three states:
- Hidden: `transform: translateX(-50%) translateY(2rem)`
- Visible: `transform: translateX(-50%) translateY(0)`
- Reduced-motion: `transform: translateX(-50%)` (no translateY at all)
  </action>
  <verify>
- `global.css` contains `/* ===== ILLUSTRATIONS ===== */` section
- `global.css` contains `.illustration` base styles with breakout layout (margin-left: 50%, transform: translateX(-50%))
- `global.css` contains `.illustration.is-visible` with opacity 1 and translateY(0)
- `global.css` contains `[data-theme="dark"] .illustration img { filter: invert(1) }` -- targeting img only
- `global.css` contains `.illustration figcaption` styles with --text-prose-muted color
- `.prose` rule includes `overflow-x: clip`
- 640px media query includes `.illustration` width constraint
- Reduced-motion media query includes `.illustration` override with opacity 1 and translateX(-50%) only
- Build succeeds: `cd site && npx astro build`
- No CSS syntax errors
  </verify>
  <done>Complete illustration CSS with breakout layout, dark mode filter inversion (img only), scroll reveal states, caption styling, overflow-x clip, mobile constraint, and reduced-motion override.</done>
</task>

</tasks>

<verification>
1. Build the site: `cd site && npx astro build` -- must succeed with zero errors
2. Verify illustration markup: grep for `class="illustration"` in index.astro -- should find 3 matches
3. Verify Astro Image usage: grep for `format="png"` in index.astro -- should find 3 matches (illustrations)
4. Verify scroll-reveal.js exists: `ls site/src/scripts/scroll-reveal.js`
5. Verify IntersectionObserver: grep for `IntersectionObserver` in scroll-reveal.js
6. Verify reduced-motion guard in JS: grep for `prefers-reduced-motion` in scroll-reveal.js
7. Verify CSS illustration section: grep for `ILLUSTRATIONS` in global.css
8. Verify dark mode filter: grep for `dark.*illustration.*invert` in global.css
9. Verify overflow-x clip: grep for `overflow-x.*clip` in global.css
10. Verify reduced-motion CSS: grep for `illustration` in the reduced-motion block of global.css
</verification>

<success_criteria>
- Three illustration figures appear in the prose section between paragraph groups
- Illustrations break out wider than 38rem prose column (up to 65rem max-width)
- Dark mode inverts illustration images via CSS filter (on img only, not caption)
- Illustrations fade in with slide-up animation when scrolled into view
- Single shared IntersectionObserver handles all three illustrations
- Reduced-motion users see illustrations immediately with no animation
- Captions display in muted text below each illustration
- No horizontal scrollbar despite breakout width (overflow-x: clip)
- Mobile breakout constrained to viewport minus padding
- Site builds successfully with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-gateway-illustrations/21-02-SUMMARY.md`
</output>
