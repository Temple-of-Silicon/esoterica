---
phase: 19-scroll-video
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - site/src/components/ScrollVideo.astro
  - site/src/scripts/scroll-scrubber.js
  - site/src/pages/index.astro
  - site/src/styles/global.css
autonomous: false

must_haves:
  truths:
    - "Scrolling the hero section plays the video forward; scrolling back plays it in reverse"
    - "First frame displays immediately as poster state before any scrolling"
    - "Video is a standard <video> element with currentTime driven by scroll position"
    - "Page loads without jank -- scroll handler uses requestAnimationFrame throttling"
    - "Hero section is ~300vh tall with sticky content pinned at top"
  artifacts:
    - path: "site/src/components/ScrollVideo.astro"
      provides: "Video element with muted/playsinline attributes and correct src path"
      min_lines: 10
    - path: "site/src/scripts/scroll-scrubber.js"
      provides: "Scroll-to-currentTime sync logic with rAF throttling"
      min_lines: 30
    - path: "site/src/pages/index.astro"
      provides: "Updated page with ScrollVideo in sticky hero structure"
    - path: "site/src/styles/global.css"
      provides: "300vh hero with sticky inner container and video styling"
  key_links:
    - from: "site/src/scripts/scroll-scrubber.js"
      to: "video#scroll-video"
      via: "getElementById to get video element"
      pattern: "getElementById.*scroll-video"
    - from: "site/src/scripts/scroll-scrubber.js"
      to: "video.currentTime"
      via: "sets currentTime based on scroll progress"
      pattern: "currentTime"
    - from: "site/src/pages/index.astro"
      to: "site/src/components/ScrollVideo.astro"
      via: "component import"
      pattern: "import ScrollVideo"
---

<objective>
Build a scroll-driven video hero using a `<video>` element whose `currentTime` is driven by scroll position — the same pattern as portfolio.jem.computer.

Architecture:
- `<video>` element: muted, playsinline, preload="auto" (NOT autoplay)
- Hero section is 300vh tall, creating 200vh of scroll travel
- Video + content pinned in a sticky container at viewport height
- JS maps scroll progress (0-1) within the hero to video.currentTime (0-duration)
- After scrolling past the 300vh hero, the page continues to the prose section

This replaces the static hero image with scroll-driven video playback.
</objective>

<context>
Key source files to modify:
- site/src/pages/index.astro — current hero with static Image
- site/src/styles/global.css — hero styling

Plan 01 output:
- Compressed video at: site/public/video/hero.mp4
- Base path is /esoterica/ (from astro.config.mjs)

Current hero structure (index.astro):
```html
<div class="hero">
  <Image ... class="hero-bg" />
  <header class="header">...</header>
  <main class="main">...</main>
  <footer class="footer">...</footer>
</div>
<section class="prose">...</section>
```

Current CSS:
- .hero: relative, min-height: 100vh/100svh, flex column, overflow hidden
- .hero-bg: absolute, inset 0, object-fit cover, z-index 0
- .hero::before: overlay with var(--bg-overlay), z-index 1
- header/main/footer: relative, z-index 10

Target structure:
```html
<div class="hero">           <!-- 300vh tall scroll container -->
  <div class="hero-sticky">  <!-- sticky, 100vh, holds everything visible -->
    <video class="hero-bg" ...></video>
    <!-- ::before overlay via CSS -->
    <header>...</header>
    <main>...</main>
    <footer>...</footer>
  </div>
</div>
<section class="prose">...</section>
```

Portfolio reference pattern (from portfolio.jem.computer):
- Video: paused, muted, playsInline, duration=10s
- Sticky parent: position sticky, top 0, viewport height
- Scroll container: ~2.5x viewport height
- JS: scroll progress → video.currentTime
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScrollVideo component and scroll-scrubber script</name>
  <files>
    site/src/components/ScrollVideo.astro
    site/src/scripts/scroll-scrubber.js
  </files>
  <action>
**ScrollVideo.astro component:**

Create `site/src/components/ScrollVideo.astro`:

```astro
---
const basePath = import.meta.env.BASE_URL;
---

<video
  id="scroll-video"
  class="hero-bg"
  src={`${basePath}video/hero.mp4`}
  muted
  playsinline
  preload="auto"
></video>
```

- `muted` + `playsinline`: Required for mobile compatibility, no autoplay
- `preload="auto"`: Browser loads the full video for smooth scrubbing
- No `autoplay`, no `controls` — scroll drives playback via JS
- `object-fit: cover` handled by CSS on `.hero-bg`

**scroll-scrubber.js:**

Create `site/src/scripts/scroll-scrubber.js`:

```javascript
(function() {
  const video = document.getElementById('scroll-video');
  if (!video) return;

  const hero = document.querySelector('.hero');
  if (!hero) return;

  let ticking = false;

  function updateVideoTime() {
    const rect = hero.getBoundingClientRect();
    const scrollable = hero.offsetHeight - window.innerHeight;
    if (scrollable <= 0) return;

    const scrolled = -rect.top;
    const progress = Math.max(0, Math.min(1, scrolled / scrollable));

    if (video.duration && isFinite(video.duration)) {
      video.currentTime = progress * video.duration;
    }
  }

  function onScroll() {
    if (ticking) return;
    ticking = true;
    requestAnimationFrame(() => {
      updateVideoTime();
      ticking = false;
    });
  }

  video.addEventListener('loadedmetadata', updateVideoTime);
  window.addEventListener('scroll', onScroll, { passive: true });
})();
```

Design decisions:
- IIFE: No module system needed, keeps global scope clean
- `{ passive: true }`: Tells browser we won't preventDefault, enabling scroll optimizations
- rAF throttle via `ticking` flag: Prevents firing faster than display refresh rate
- `scrollable = heroHeight - viewportHeight`: The actual distance the sticky content can travel
- `progress = -rect.top / scrollable`: 0 at top of hero, 1 when hero's bottom reaches viewport bottom
- `loadedmetadata` listener: Sets initial frame based on current scroll position (handles page reload while scrolled)
  </action>
  <verify>
- `ls site/src/components/ScrollVideo.astro` exists
- `ls site/src/scripts/scroll-scrubber.js` exists
- ScrollVideo.astro contains a video element with id="scroll-video", muted, playsinline
- scroll-scrubber.js contains: requestAnimationFrame, currentTime, passive: true
- No npm dependencies added
  </verify>
  <done>
ScrollVideo.astro renders a video element with correct attributes. scroll-scrubber.js maps scroll position to video.currentTime with rAF throttling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ScrollVideo into hero section</name>
  <files>
    site/src/pages/index.astro
    site/src/styles/global.css
  </files>
  <action>
**Update index.astro:**

1. Add ScrollVideo import, keep Image for noscript fallback:
```astro
---
import Base from '../layouts/Base.astro';
import { Image } from 'astro:assets';
import heroImage from '../assets/hero-primary.png';
import ScrollVideo from '../components/ScrollVideo.astro';
---
```

2. Restructure the hero with a sticky inner container:
```html
<div class="hero">
  <div class="hero-sticky">
    <ScrollVideo />
    <noscript>
      <Image src={heroImage} alt="Sacred altar with tarot cards" width={1920} quality={80} format="webp" class="hero-bg" />
    </noscript>

    <header class="header">...</header>
    <main class="main">...</main>
    <footer class="footer">...</footer>
  </div>
</div>
```

Header, main, and footer content stay exactly the same — just wrapped in `.hero-sticky`.

3. Add the scroll-scrubber script at the bottom of the page (after the existing script block):
```html
<script>
  import '../scripts/scroll-scrubber.js';
</script>
```

**Update global.css:**

1. Change `.hero` from flex container to tall scroll section:
```css
.hero {
  position: relative;
  height: 300vh;
}
```

Remove `min-height: 100vh`, `min-height: 100svh`, `display: flex`, `flex-direction: column`, `overflow: hidden`.

2. Add `.hero-sticky` — the sticky container that holds everything visible:
```css
.hero-sticky {
  position: sticky;
  top: 0;
  height: 100vh;
  height: 100svh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
```

This takes on the layout role that `.hero` previously had.

3. Move `.hero::before` overlay to `.hero-sticky::before`:
```css
.hero-sticky::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--bg-overlay);
  transition: background 0.3s ease;
  z-index: 1;
}
```

Remove the old `.hero::before` rule.

4. The `.hero-bg` class works for both video and img (noscript). The existing `object-fit: cover` applies to video elements too. No changes needed to `.hero-bg` except removing the iOS Safari fix (sticky replaces the absolute positioning concern):

Keep `.hero-bg` as-is:
```css
.hero-bg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 0;
}
```

Remove the `@supports (-webkit-touch-callout: none)` block since the sticky approach handles iOS correctly.

5. All other styles (header, main, footer, content, tagline, etc.) remain unchanged — they already have `position: relative; z-index: 10` to appear above the overlay.
  </action>
  <verify>
- `cd site && npm run build` completes without errors
- index.astro has ScrollVideo import and hero-sticky wrapper
- global.css has .hero at 300vh and .hero-sticky with position: sticky
- .hero::before is gone, replaced by .hero-sticky::before
  </verify>
  <done>
ScrollVideo integrated into hero. 300vh tall hero with sticky inner container. Video replaces static image. Content overlays video. Build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Scroll-driven video hero section. The source MP4 is compressed and served as a video element. Scrolling through the 300vh hero section scrubs the video forward/backward by mapping scroll position to video.currentTime. Content (header, tagline, install command) overlays the video in a sticky container.
  </what-built>
  <how-to-verify>
1. Run `cd site && npm run dev` if not already running
2. Open http://localhost:4321/esoterica/ in Chrome
3. Verify: First frame of video is visible as the hero background
4. Scroll down slowly — video should play forward smoothly
5. Scroll back up — video should reverse
6. Keep scrolling past the hero — prose section should appear normally
7. Verify: Header text, tagline, and install command overlay the video
8. Verify: Theme toggle still works
9. Resize browser window — video should maintain cover behavior
10. Check browser console (F12) — no errors
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/behavioral issues</resume-signal>
</task>

</tasks>

<verification>
Phase 19 success requires ALL of these to be TRUE:
1. Scrolling the hero section plays the video forward; scrolling back plays it in reverse
2. First frame displays immediately as poster state before any scrolling
3. Video is a <video> element with currentTime driven by scroll (not canvas/frames)
4. Source video is compressed from 25MB to under 5MB
5. Page loads without jank — scroll handler uses requestAnimationFrame throttling
</verification>

<success_criteria>
- Compressed video exists in site/public/video/hero.mp4
- Video element renders with scroll-driven playback
- First frame shows immediately (no blank state)
- Scroll forward = video forward, scroll backward = video reverse
- rAF throttling prevents scroll jank
- Existing hero content (header, tagline, install) overlays the video
- Theme toggle, prose section, and all existing functionality preserved
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-scroll-video/19-02-SUMMARY.md`
</output>
