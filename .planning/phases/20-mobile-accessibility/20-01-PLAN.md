---
phase: 20-mobile-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - site/public/video/hero-poster.jpg
  - site/src/components/ScrollVideo.astro
  - site/src/scripts/scroll-scrubber.js
  - site/src/styles/global.css
autonomous: true

must_haves:
  truths:
    - "Users with prefers-reduced-motion see a static poster image, not a video"
    - "Hero collapses to 100vh when reduced-motion is active, no blank scroll gap"
    - "All CSS transitions are disabled site-wide when reduced-motion is active"
    - "Video does not download for reduced-motion users (src removed in JS)"
    - "iOS Safari shows first frame via poster attribute on the video element"
    - "Viewport resize recalculates scroll-to-video mapping correctly"
  artifacts:
    - path: "site/public/video/hero-poster.jpg"
      provides: "Static poster frame extracted from hero.mp4 first frame"
    - path: "site/src/components/ScrollVideo.astro"
      provides: "Video element with poster attribute"
      contains: "poster="
    - path: "site/src/scripts/scroll-scrubber.js"
      provides: "Reduced-motion early exit, resize handler"
      contains: "prefers-reduced-motion"
    - path: "site/src/styles/global.css"
      provides: "Reduced-motion media query overrides"
      contains: "prefers-reduced-motion"
  key_links:
    - from: "site/src/scripts/scroll-scrubber.js"
      to: "matchMedia('(prefers-reduced-motion: reduce)')"
      via: "early return before scroll handler registration"
      pattern: "prefersReducedMotion.*matches"
    - from: "site/src/styles/global.css"
      to: ".hero height override"
      via: "@media (prefers-reduced-motion: reduce)"
      pattern: "prefers-reduced-motion.*\\.hero"
---

<objective>
Add prefers-reduced-motion support and viewport resize handling to the scroll-driven video hero.

Purpose: Ensure the Phase 19 scroll video degrades gracefully for users who prefer reduced motion (WCAG 2.1 compliance) and handles viewport changes correctly. Extract a poster frame for the static fallback.

Output: hero-poster.jpg, updated ScrollVideo.astro with poster attribute, scroll-scrubber.js with motion detection and resize handler, global.css with reduced-motion overrides.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-mobile-accessibility/20-CONTEXT.md
@.planning/phases/20-mobile-accessibility/20-RESEARCH.md
@site/src/components/ScrollVideo.astro
@site/src/scripts/scroll-scrubber.js
@site/src/styles/global.css
@site/src/pages/index.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract poster frame and add poster attribute to video</name>
  <files>site/public/video/hero-poster.jpg, site/src/components/ScrollVideo.astro</files>
  <action>
1. Extract the first frame from the hero video as a JPEG poster image:
   ```bash
   ffmpeg -i site/public/video/hero.mp4 -frames:v 1 -q:v 2 site/public/video/hero-poster.jpg
   ```
   This should produce a ~100-150KB JPEG at 1920x1068.

2. Update `site/src/components/ScrollVideo.astro` to add a `poster` attribute to the video element. The poster path must use the same `basePath` variable already computed in the component's frontmatter. Also add `#t=0.001` to the video src URL as an iOS Safari fix to guarantee first-frame display.

   The updated video element should look like:
   ```html
   <video
     id="scroll-video"
     class="hero-bg"
     src={`${basePath}video/hero.mp4#t=0.001`}
     poster={`${basePath}video/hero-poster.jpg`}
     muted
     playsinline
     preload="auto"
   ></video>
   ```

   Also add a hidden poster `<img>` element directly after the video, for reduced-motion users. This img is hidden by default and shown via CSS when reduced-motion is active:
   ```html
   <img
     class="hero-bg hero-bg-poster"
     src={`${basePath}video/hero-poster.jpg`}
     alt="Woven threads emerging from cosmic patterns"
     aria-hidden="true"
   />
   ```

   Add `class="hero-bg hero-bg-video"` to the video element (replacing the existing `class="hero-bg"`), so CSS can target video and poster separately.
  </action>
  <verify>
- `site/public/video/hero-poster.jpg` exists and is a valid JPEG (use `file` command)
- `site/src/components/ScrollVideo.astro` contains `poster=` attribute
- `site/src/components/ScrollVideo.astro` contains `#t=0.001` in video src
- `site/src/components/ScrollVideo.astro` contains `.hero-bg-poster` img element
- Build succeeds: `cd site && npx astro build`
  </verify>
  <done>Poster image extracted, video element has poster attribute and iOS Safari fix, hidden poster img element exists for reduced-motion swap.</done>
</task>

<task type="auto">
  <name>Task 2: Add reduced-motion CSS overrides, JS motion detection, and resize handler</name>
  <files>site/src/styles/global.css, site/src/scripts/scroll-scrubber.js</files>
  <action>
1. **global.css** -- Add a `@media (prefers-reduced-motion: reduce)` block at the end of the file (before the responsive media queries, or after them -- position among other media queries). This block must:

   a. Kill all transitions and animations site-wide:
      ```css
      *, *::before, *::after {
        animation-duration: 0.001ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.001ms !important;
      }
      ```

   b. Collapse hero to single viewport height:
      ```css
      .hero {
        height: 100vh;
        height: 100svh;
      }
      ```

   c. Hide video, show poster:
      ```css
      .hero-bg-video {
        display: none;
      }
      .hero-bg-poster {
        display: block;
      }
      ```

   d. Ensure text content is immediately visible (no opacity/transform animation):
      ```css
      .tagline, .description, .install {
        opacity: 1 !important;
        transform: none !important;
      }
      ```

   Also add a default rule (outside the media query) to hide the poster img by default:
   ```css
   .hero-bg-poster {
     display: none;
   }
   ```

2. **scroll-scrubber.js** -- Modify the IIFE to:

   a. Add reduced-motion detection at the very top of the IIFE (before the video/hero element lookups). If `prefers-reduced-motion: reduce` matches, remove the video `src` attribute (to prevent the 1.8MB download), call `video.load()` to reset, and return early. Do NOT register scroll or resize handlers.

      ```javascript
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
      if (prefersReducedMotion.matches) {
        const vid = document.getElementById('scroll-video');
        if (vid) {
          vid.removeAttribute('src');
          vid.load();
        }
        return;
      }
      ```

      Place this BEFORE the existing `const video = document.getElementById('scroll-video');` line. The existing early-return for missing video stays as-is.

   b. Add a passive resize listener at the end of the IIFE (after the existing scroll listener):
      ```javascript
      window.addEventListener('resize', function() {
        if (!ticking) {
          ticking = true;
          requestAnimationFrame(function() {
            updateVideoTime();
            ticking = false;
          });
        }
      }, { passive: true });
      ```

      This reuses the existing `ticking` flag and `updateVideoTime()` function. The existing function already reads live dimensions via `hero.getBoundingClientRect()` and `hero.offsetHeight`, so no additional changes needed for resize correctness.
  </action>
  <verify>
- `global.css` contains `@media (prefers-reduced-motion: reduce)` block
- `global.css` contains `.hero-bg-poster { display: none; }` default rule
- `scroll-scrubber.js` contains `prefers-reduced-motion` check at top of IIFE
- `scroll-scrubber.js` contains `resize` event listener
- Build succeeds: `cd site && npx astro build`
- No console errors when loading the page
  </verify>
  <done>Reduced-motion users see static poster (video src removed to prevent download), hero collapses to 100vh, all transitions killed. Viewport resize recalculates video time mapping correctly.</done>
</task>

</tasks>

<verification>
1. Build the site: `cd site && npx astro build` -- must succeed with zero errors
2. Check that `site/public/video/hero-poster.jpg` exists and is a valid image
3. Verify reduced-motion CSS: grep for `prefers-reduced-motion` in global.css
4. Verify JS motion detection: grep for `prefers-reduced-motion` in scroll-scrubber.js
5. Verify resize handler: grep for `resize` in scroll-scrubber.js
6. Verify poster attribute: grep for `poster=` in ScrollVideo.astro
</verification>

<success_criteria>
- hero-poster.jpg exists in site/public/video/
- Video element has poster attribute and #t=0.001 iOS fix
- Reduced-motion CSS collapses hero to 100vh, hides video, shows poster img
- JS skips scroll handler and removes video src for reduced-motion users
- Resize handler recalculates video time on viewport change
- Site builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/20-mobile-accessibility/20-01-SUMMARY.md`
</output>
