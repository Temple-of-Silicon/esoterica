---
phase: 04-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/skills/tarot/SKILL.md
autonomous: false

must_haves:
  truths:
    - "User can set global voice preference that persists"
    - "User can set project-level voice preference that overrides global"
    - "--voice flag still overrides all config"
    - "Default remains 'grounded' when no config exists"
  artifacts:
    - path: "~/.claude/skills/tarot/SKILL.md"
      provides: "Config reading in voice shell injection"
      contains: "grep '^voice='"
  key_links:
    - from: "~/.claude/skills/tarot/SKILL.md"
      to: "~/.claude/tarot/config"
      via: "grep-based config parsing"
      pattern: "grep.*voice=.*\\.claude/tarot/config"
    - from: "~/.claude/skills/tarot/SKILL.md"
      to: ".tarot"
      via: "grep-based config parsing"
      pattern: "grep.*voice=.*\\.tarot"
---

<objective>
Add persistent voice preference via config file support to the tarot skill.

Purpose: Users can set a default voice (mystic/grounded) that persists across readings without needing --voice flag every time.

Output: Modified SKILL.md with config reading in the voice shell injection, supporting both global (~/.claude/tarot/config) and project-level (.tarot) config files.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-configuration/04-CONTEXT.md
@.planning/phases/04-configuration/04-RESEARCH.md
@~/.claude/skills/tarot/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config file reading to voice shell injection</name>
  <files>~/.claude/skills/tarot/SKILL.md</files>
  <action>
Modify the **Voice:** shell injection in the "## Reading Context" section to implement the precedence chain:

1. `--voice` flag (already implemented - keep this check first)
2. Project-level `.tarot` file (check current directory)
3. Global `~/.claude/tarot/config` file
4. Default "grounded" (already implemented - keep as final fallback)

Implementation approach from 04-RESEARCH.md:
- Use grep + cut for safe parsing (NEVER source the config files)
- Use `$HOME` not `~` for path expansion in script
- Validate extracted values against "mystic" or "grounded"
- Silent fallback on any error (missing file, unreadable, malformed)

The current voice line is:
```bash
**Voice:** `!echo "$ARGUMENTS" | grep -oiE '\-\-voice\s+(mystic|grounded)' | awk '{print tolower($2)}' | grep -q . && echo "$ARGUMENTS" | grep -oiE '\-\-voice\s+(mystic|grounded)' | awk '{print tolower($2)}' || echo "grounded"`
```

Replace with a multi-step check:
1. First try --voice flag (existing logic)
2. If empty, try project .tarot file
3. If empty, try global config
4. If empty or invalid, use "grounded"

Use compound commands with proper error handling. Keep it on a single backtick line as the current implementation does.

Update the comment at the bottom of the file:
- Remove `<!-- Phase 4 will add: persistent default voice setting in config -->`
- Add comment documenting the config locations and precedence

Config file format (document in comment):
```
# Tarot voice preference
voice=mystic
```
  </action>
  <verify>
Manual verification of shell injection syntax:
1. Read the modified SKILL.md
2. Confirm the Voice line contains checks for both `.tarot` and `$HOME/.claude/tarot/config`
3. Confirm grep-based parsing (not source/eval)
4. Confirm validation against "mystic" and "grounded" only
5. Confirm fallback to "grounded" as default
  </verify>
  <done>
- SKILL.md contains updated voice shell injection with config reading
- Precedence chain: flag > project .tarot > global config > default
- Uses safe grep/cut parsing
- Comment documents config locations and format
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Config-based voice preference system. The skill now reads voice preference from:
1. `--voice` flag (highest priority)
2. Project-level `.tarot` file
3. Global `~/.claude/tarot/config` file
4. Default "grounded" (lowest priority)
  </what-built>
  <how-to-verify>
Test the precedence chain:

1. **Test default (no config):**
   - Ensure no `.tarot` file exists in current directory
   - Ensure no `~/.claude/tarot/config` file exists
   - Run `/tarot` - should use grounded voice

2. **Test global config:**
   - Create global config: `mkdir -p ~/.claude/tarot && echo "voice=mystic" > ~/.claude/tarot/config`
   - Run `/tarot` - should use mystic voice

3. **Test project override:**
   - Create project config: `echo "voice=grounded" > .tarot`
   - Run `/tarot` - should use grounded voice (project overrides global)

4. **Test flag override:**
   - With both configs present
   - Run `/tarot --voice mystic` - should use mystic voice (flag overrides all)

5. **Cleanup:**
   - `rm .tarot` (if created)
   - Optionally keep `~/.claude/tarot/config` if you want a persistent preference
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe which test failed</resume-signal>
</task>

</tasks>

<verification>
- [ ] SKILL.md voice injection reads from config files
- [ ] Precedence: flag > project .tarot > global ~/.claude/tarot/config > default
- [ ] Uses safe grep/cut parsing (no source/eval)
- [ ] Invalid config values fall back to default
- [ ] Missing/unreadable config files fall back silently
- [ ] Human verified all precedence levels work
</verification>

<success_criteria>
- User can create `~/.claude/tarot/config` with `voice=mystic` and all readings use mystic voice
- User can create `.tarot` in a project with `voice=grounded` to override global preference
- `--voice` flag still overrides all config settings
- No config = grounded default (existing behavior preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/04-configuration/04-01-SUMMARY.md`
</output>
