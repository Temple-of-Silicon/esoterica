---
phase: 12-visual-language
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/generate-image/SKILL.md
  - skills/generate-image/package.json
  - skills/generate-image/tsconfig.json
  - skills/generate-image/src/index.ts
  - skills/generate-image/src/replicate-client.ts
  - skills/generate-image/src/prompt-builder.ts
  - skills/generate-image/src/types.ts
autonomous: true
user_setup:
  - service: replicate
    why: "AI image generation via Nano Banana Pro model"
    env_vars:
      - name: REPLICATE_API_TOKEN
        source: "Replicate Dashboard -> Account Settings -> API tokens"
    dashboard_config: []

must_haves:
  truths:
    - "Claude can invoke /generate-image skill to create images"
    - "Generated images are saved locally before URLs expire"
    - "Prompt template maintains Esoterica's eco-futurist aesthetic"
  artifacts:
    - path: "skills/generate-image/SKILL.md"
      provides: "Skill invocation documentation"
      contains: "generate-image"
    - path: "skills/generate-image/src/replicate-client.ts"
      provides: "Replicate API wrapper with polling"
      contains: "predictions.create"
    - path: "skills/generate-image/src/prompt-builder.ts"
      provides: "Eco-futurist prompt templates"
      contains: "buildEsotericaPrompt"
  key_links:
    - from: "skills/generate-image/SKILL.md"
      to: "replicate-client.ts"
      via: "skill invokes client"
      pattern: "generateImage"
    - from: "skills/generate-image/src/index.ts"
      to: "REPLICATE_API_TOKEN"
      via: "environment variable"
      pattern: "process\\.env\\.REPLICATE"
---

<objective>
Create the generate-image skill for Esoterica enabling Claude to generate images via Replicate's Nano Banana Pro model.

Purpose: This skill enables agentic image generation during plan execution, maintaining the eco-futurist utopian divine feminine aesthetic across all visuals.

Output: A functional MCP skill that can be invoked as /generate-image with scene description, aspect ratio, and variation count parameters.
</objective>

<execution_context>
@/Users/jem/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jem/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-visual-language/12-CONTEXT.md
@.planning/phases/12-visual-language/12-RESEARCH.md
@skills/tarot/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skill infrastructure</name>
  <files>
    skills/generate-image/SKILL.md
    skills/generate-image/package.json
    skills/generate-image/tsconfig.json
    skills/generate-image/src/types.ts
  </files>
  <action>
Create the generate-image skill following the tarot skill pattern:

1. **SKILL.md** - Skill documentation with frontmatter:
   - name: generate-image
   - description: Generate images using Replicate's Nano Banana Pro model with Esoterica's eco-futurist aesthetic
   - agent: general-purpose
   - Include usage section showing parameters: scene, aspect_ratio (16:9, 1:1, 9:16), variations (1-10), resolution (1K, 2K, 4K)
   - Document that images are saved to brand/hero/archive/ with timestamps
   - Note: No wizard flow - accepts inline parameters for batch generation

2. **package.json** - Skill dependencies:
   - name: "@esoterica/generate-image"
   - type: "module"
   - dependencies: replicate (latest), sharp (latest), get-image-colors (latest)
   - devDependencies: typescript, @types/node

3. **tsconfig.json** - TypeScript config:
   - target: ES2022
   - module: NodeNext
   - moduleResolution: NodeNext
   - outDir: dist
   - strict: true

4. **src/types.ts** - Type definitions:
   - PromptConfig interface (sceneDescription, screenContent?, figures?, timeOfDay?)
   - GenerateOptions interface (scene, aspectRatio, variations, resolution, outputDir)
   - GenerationResult interface (id, prompt, imagePath, timestamp)
  </action>
  <verify>
    - `ls skills/generate-image/` shows SKILL.md, package.json, tsconfig.json, src/types.ts
    - `cat skills/generate-image/SKILL.md | head -10` shows frontmatter with name: generate-image
  </verify>
  <done>Skill infrastructure exists with proper structure matching tarot skill pattern</done>
</task>

<task type="auto">
  <name>Task 2: Implement Replicate client with polling</name>
  <files>
    skills/generate-image/src/replicate-client.ts
    skills/generate-image/src/index.ts
  </files>
  <action>
Implement the Replicate API client following patterns from RESEARCH.md:

1. **src/replicate-client.ts**:
   - Import Replicate from "replicate"
   - Create ReplicateClient class with:
     - Constructor taking apiToken (from env)
     - `generateImage(prompt: string, aspectRatio: string, resolution: string): Promise<string[]>` method
   - Use Nano Banana Pro version: "0785fb14f5aaa30eddf06fd49b6cbdaac4541b8854eb314211666e23a29087e3"
   - Implement async polling with exponential backoff (2s, 4s, 8s, cap at 10s)
   - Max 60 attempts (~10 minutes timeout)
   - Handle rate limit (429) with 60-second retry
   - Return array of image URLs on success
   - Add `downloadImage(url: string, outputPath: string): Promise<void>` method using fetch + fs.writeFile
   - Log progress: "Polling prediction {id}... (attempt {n})"

2. **src/index.ts** - Main entry point:
   - Import types from types.ts
   - Import ReplicateClient from replicate-client.ts
   - Import buildEsotericaPrompt from prompt-builder.ts (will be created next task)
   - Export `generateImages(options: GenerateOptions): Promise<GenerationResult[]>` function
   - For each variation:
     - Build prompt using buildEsotericaPrompt
     - Call client.generateImage
     - Download immediately to outputDir with filename: `hero-{timestamp}-{index}.png`
     - Return array of GenerationResult with id, prompt, imagePath, timestamp
   - Add 150ms delay between generations to respect rate limits

Note: Requires REPLICATE_API_TOKEN environment variable. Error if not set.
  </action>
  <verify>
    - `cat skills/generate-image/src/replicate-client.ts | grep -c "predictions.create"` returns 1
    - `cat skills/generate-image/src/replicate-client.ts | grep -c "exponential"` returns at least 1 (in comments or logic)
    - `cat skills/generate-image/src/index.ts | grep "REPLICATE_API_TOKEN"` shows env var check
  </verify>
  <done>Replicate client handles async polling, rate limits, and immediate download of generated images</done>
</task>

<task type="auto">
  <name>Task 3: Implement prompt template builder</name>
  <files>skills/generate-image/src/prompt-builder.ts</files>
  <action>
Create the prompt template builder that maintains Esoterica's aesthetic:

**src/prompt-builder.ts**:
- Import PromptConfig from types.ts
- Export `buildEsotericaPrompt(config: PromptConfig): string` function

Template structure (from CONTEXT.md and RESEARCH.md):
```
Candid scene from an eco-futurist utopian divine feminine society {sceneDescription}, 1980s-meets-2180s. Kodak Eastman 100T 5247 35mm film, grain, halation, faded warm colors, natural lens flares, shallow depth-of-field. {deviceClause}. Diverse women in flowing white, black, or iridescent gauzey cotton max-dresses, opal, labradorite, moonstone, amethyst jewelry, silver, black, or iridescent fingernails. Soft, peaceful, gentle, pastoral cybernetic merging of femininity & technology.
```

Where:
- {sceneDescription} comes from config.sceneDescription
- {deviceClause} = "Selenite crystal devices with {config.screenContent}" if screenContent provided, else "Selenite crystal devices with glowing screens"

Add figures handling:
- If config.figures === "hands_only": append "Focus on hands and objects, no faces visible."
- If config.figures === "no_people": append "Scene without people, focusing on objects and environment."
- If config.figures === "background_figures": append "Figures softly blurred in background."

Add time of day handling:
- If config.timeOfDay provided: prepend to sceneDescription (e.g., "at golden hour sunrise, ")

Export `HERO_PROMPT_CONFIG` constant with default hero settings:
```typescript
export const HERO_PROMPT_CONFIG: PromptConfig = {
  sceneDescription: "at a sacred altar in a sun-drenched Joshua Tree grove at sunrise, three tarot cards (High Priestess, Justice, Chariot) laid beside a selenite crystal-computer",
  screenContent: "16:9 screen displaying terminal text with mystical symbols",
  figures: "hands_only",
  timeOfDay: "golden hour sunrise, pink-gold morning light"
};
```

Keep prompts under 75 words total (model performs better with concise, high-signal keywords).
  </action>
  <verify>
    - `cat skills/generate-image/src/prompt-builder.ts | grep "buildEsotericaPrompt"` shows function export
    - `cat skills/generate-image/src/prompt-builder.ts | grep "HERO_PROMPT_CONFIG"` shows constant export
    - `cat skills/generate-image/src/prompt-builder.ts | grep "Joshua Tree"` confirms hero scene included
  </verify>
  <done>Prompt builder generates eco-futurist prompts maintaining Esoterica's visual language with locked aesthetic elements</done>
</task>

</tasks>

<verification>
Overall skill verification:
1. Directory structure: `ls -la skills/generate-image/src/` shows all 4 TypeScript files
2. Dependencies installable: `cd skills/generate-image && npm install` succeeds (if user has REPLICATE_API_TOKEN)
3. TypeScript compiles: `cd skills/generate-image && npx tsc --noEmit` passes
4. SKILL.md readable: Skill documentation explains usage clearly
</verification>

<success_criteria>
- Generate-image skill exists at skills/generate-image/ following tarot skill pattern
- Replicate client implements async polling with exponential backoff and rate limit handling
- Prompt builder enforces eco-futurist aesthetic with configurable scene elements
- Images are downloaded immediately to avoid URL expiration
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-visual-language/12-01-SUMMARY.md`
</output>
